---
title: "Power calculations"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: united
    highlight: tango
    code_folding: hide
params:
  author: "Ben Jaques-Leslie"
  project_number: 2233
  project_name: "USWDS Digital Dashboard"
  data: "wds.rdata"
  sample_min: 100
  sample_max: 2000
  ate: -1
  ate_min: .1
  ate_max: .25
  error_variance: .45
  treatment_probability: .5
  panels_min: 1
  panels_max: 4
  treatment_at_min: 1
  treatment_at_max: 4
  simulations: 5000
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(skimr)
library(DataExplorer)
library(readr)
library(oesrrr)
library(oescolorrrs)
library(ggthemes)
library(DesignLibrary)
library(MASS)
```

# Power calculations {.tabset .tabset-pills}

**Project number**: `r params$project_number`

**Project name**: `r params$project_name`

**Author**: `r params$author`

**Data**: `r params$data`'

## Load data {.tabset .tabset-pills}

### Data from `r params$data`

```{r}
load(here::here("03. Data Collection",params$data))
```

Review data.

```{r}
d %>% skim()
```

Review the data by outcome and treatment.

```{r}
d %>% group_by(name) %>%  skim()
```

## Understanding the outcome distribution {.tabset .tabset-pills}

### Overall distribution of issues.

Issues are very left skewed. This drops null values, which may not be the right choice.

```{r}
d %>%
  filter(name != "uswds_score") %>%
  ggplot(aes(x = value)) +
  geom_density() +
  theme_fivethirtyeight() +
  scale_fill_oes()
```

### Distribution by issue count and WDS score.

Again issues are very left skewed. This is consistent across the issue types. WDS score is really an indicator.

```{r}
d %>%
  ggplot(aes(x = value, fill = name)) +
  geom_histogram() +
  scale_fill_oes(palette = "full colors") +
  theme_fivethirtyeight()
```

When we treat the null values as zero, we have greater skew.

```{r}
d %>%
  mutate(value = replace_na(value, 0)) %>%
  ggplot(aes(x = value, fill = name)) +
  geom_histogram() +
  scale_fill_oes(palette = "full colors") +
  theme_fivethirtyeight() +
  facet_wrap('name', scales = "free")
```

Outcome distribution is very left skewed and may be better model by a negative binomial distribution.
<!--
JB: If this is a randomized trial then we don't need to choose a model of the
outcome. See Chapter 3 of Gerber and Green field experiments or the materials on
estimation in https://egap.github.io/theory_and_practice_of_field_experiments/

-->

## Power analysis {.tabset .tabset-pills}

### Assumptions

Several assumptions are based on the means and sample size of the USWDS data.
<!--
https://english.stackexchange.com/questions/15081/based-on-instead-of-based-off-of
-->

```{r}
prep_01 <-
  d %>%
  group_by(name) %>%
  summarise(mean = mean(value, na.rm = TRUE),
            websites = n_distinct(website)) %>%
  ungroup()

prep_01
```

Using the color contrast issues count as the primary outcome of interest. The assumed population mean is the mean issues.

```{r}
population_mean_color_contrast_issues <-
  prep_01 %>%
  filter(name == "color_contrast_issues") %>%
  pull(mean)

population_mean_color_contrast_issues
```

The populations size is the number of websites measured for color contrast issues.

```{r}
population_size_color_contrast_issues <-
  prep_01 %>%
  filter(name == "color_contrast_issues") %>%
  pull(websites)

population_size_color_contrast_issues
```

The proportion treated is the proportion of screened websites that have the USWDS indicator.

```{r}
population_treatement_proportion <-
  d %>%
  filter(name == "uswds_score") %>%
  filter(value == 100) %>%
  summarise(websites = n_distinct(website)) %>%
  pull(websites)/population_size_color_contrast_issues

population_treatement_proportion
```

The assumed average treatment effect is `r params$ate`. We are assuming that the use of USWDS will decrease the number of issues by `r params$ate`.

Based on the evaluation of the outcome indicators above, we are assuming that the outcome indicators follow a negative binomial distribution.

The treatment effect is likely to come from a negative binomial distribution on the left side of zero as the treatment is unlikely to increase issues and follow a similar distribution to the outcome.

We calculate the treatment effect with this formula:

$$
Y_1 = \beta_0 + \beta_1Treatment + \beta_2Y_0
$$

### Calculating power

The function below calculates the betas based on the assumptions above.

```{r}
simulation_01 <- function(
    in_iteration,
    in_population_size,
    in_ate,
    in_population_mean,
    in_prop_assigned_treatment,
    in_outcome_distribution)
{
  # Treatment effect
  effect <- -rnbinom(in_population_size, size = 1, mu = -in_ate)

  # Outcome distribution
  outcome_0 <- rnbinom(in_population_size, size = 1, mu = in_population_mean)

  # Simulated data
  pop_01 <- fabricate(
  N = in_population_size,
  effect = effect,
  treatment = complete_ra(N = in_population_size,prob = in_prop_assigned_treatment),
  outcome_0 = outcome_0,
  outcome_1 = case_when(
    effect*treatment + outcome_0 < 0 ~ 0,
    effect*treatment + outcome_0 >= 0 ~ effect*treatment + outcome_0
  )
)

  # JB: I think that glm.nb is unnecessary and makes it hard to interpret the
  # coefs. Again, see the proofs of the unbiasedness of the difference of means
  # as an estimator of the average treatment effect

  if(in_outcome_distribution == "negative binomial")
  {
      reg <-
          pop_01 %>% MASS::glm.nb(outcome_1 ~ treatment + outcome_0, data = ., maxit = 1000)
  }

  if(in_outcome_distribution == "normal")
    {
  reg <-
  pop_01 %>% lm_robust(outcome_1 ~ treatment + outcome_0, data = .)
  }

  out <- reg %>%
    tidy() %>%
    mutate(iteration = as.character(in_iteration)) %>%
    dplyr::select(iteration, everything())

  return(out)
}
```

We create `r scales::comma(params$simulations)` of this function.

```{r}
sims <-
  1:params$simulations %>%
  map_dfr(~simulation_01(in_iteration = .,
              in_population_size = population_size_color_contrast_issues,
              in_ate = params$ate,
              in_population_mean = population_mean_color_contrast_issues,
              in_prop_assigned_treatment = population_treatement_proportion,
              in_outcome_distribution = "normal")
  )
```

For the the treatment estimates, we calculate the the 80th percentile.

<!-- JB I'm
not sure what is happening here. Don't you want to know whether 80% of the
time you've reject the null of no effects given a particular treatment effect?
-->

```{r}
prep_01 <-
  sims %>%
  filter(term == 'treatment') %>%
  summarise(
    # q_10 = quantile(estimate,probs = 0.1),
    #         q_20 = quantile(estimate,probs = 0.2),
    #         q_50 = quantile(estimate,probs = 0.5),
    #         median = median(estimate),
            q_80 = quantile(estimate,
                            probs = 0.8,names = FALSE),
            # q_90 = quantile(estimate,probs = 0.9)
    ) %>%
  rownames_to_column() %>%
  pivot_longer(-rowname) %>%
  dplyr::select(-rowname) %>%
  mutate(label = glue::glue("MDE: {scales::comma(value, accuracy = .01)}"))

```

### Minimum detectable effect

The estimated beta of the treatment are shown below with the MDE of `r prep_01 %>% pull(value) %>% scales::comma(accuracy = .01)`.

```{r}
prep_02 <- sims %>%
           filter(term == 'treatment')
```

The chart below shows the distribution of betas with an vertical line for the MDE.

```{r}
ggplot() +
  geom_density(data = prep_02,
         aes(x = estimate, color = term, fill = term),
         alpha = .1) +
  geom_vline(data = prep_01, aes(xintercept = value)) +
  geom_text(data = prep_01, aes(x = value, label=label, y=Inf), hjust = -0.25,vjust = 1) +
  ggthemes::theme_fivethirtyeight() +
  scale_color_oes() +
  scale_fill_oes() +
  labs(
    title = "Distribution of estimated treatment betas",
    subtitle = glue::glue("Population size: {scales::comma(population_size_color_contrast_issues)}
                          Population outcome mean: {scales::comma(population_mean_color_contrast_issues, accuracy = .01)}
                          Population treatment proportion: {scales::comma(population_treatement_proportion, accuracy = .01)}
                          Population treatment effect: {scales::comma(params$ate, accuracy = .01)}
                          Number of simulations: {scales::comma(params$simulations)}
                          ")
  ) +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5,
                                 size = 10)
  )
```
